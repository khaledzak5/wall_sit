class t{constructor(){this.pose=null,this.isInitialized=!1,this.perModeState={};this.perModeState.pushups={state:"up",count:0},this.perModeState.squats={state:"up",count:0},this.perModeState.lunges={state:"up",count:0},this.perModeState.burpees={state:"up",count:0},this.perModeState.mountainclimbers={state:"neutral",count:0,_lastLeftKneeY:null,_lastRightKneeY:null,_climberState:"neutral",_lastClimberTime:0},this.perModeState.highknees={state:"down",count:0},this.perModeState.jumpingjacks={state:"down",count:0},this.perModeState.sideplank={state:"neutral",count:0,_stableCount:0,_lastHipY:null,_lastShoulderY:null,_lastAnkleY:null,_lastTimestamp:0},this.perModeState.plank={state:"neutral",count:0,_stableCount:0,_lastHipY:null,_lastShoulderY:null,_lastAnkleY:null,_lastTimestamp:0},this.postureStatus="unknown",this.lastWarningTime=0,this.videoDimensionsLogged=!1,this.exerciseMode="pushups",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onPushupCount=null,this.onPostureChange=null,this.onFormFeedback=null,this.onTimeUpdate=null}setExerciseMode(t){this.perModeState[this.exerciseMode]||(this.perModeState[this.exerciseMode]={state:"up",count:0});const e=String(t||"").toLowerCase();"plank"===e?this.exerciseMode="plank":"squats"===e||"squat"===e?this.exerciseMode="squats":"lunges"===e||"lunge"===e?this.exerciseMode="lunges":"burpees"===e||"burpee"===e?this.exerciseMode="burpees":e.includes("mountain")||e.includes("climber")?this.exerciseMode="mountainclimbers":e.includes("high")&&e.includes("knees")?this.exerciseMode="highknees":e.includes("jumping")&&e.includes("jack")?this.exerciseMode="jumpingjacks":e.includes("side")&&e.includes("plank")?this.exerciseMode="sideplank":this.exerciseMode="pushups"}async initialize(){var t;try{if(!window.Pose){let t=0;for(;!window.Pose&&t<50;)await new Promise(t=>setTimeout(t,200)),t++;if(!window.Pose)return!1}this.pose=new window.Pose({locateFile:t=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${t}`});const e=(null==(t=window.MediaPipeConfig)?void 0:t.POSE_CONFIG)||{modelComplexity:0,smoothLandmarks:!0,enableSegmentation:!1,smoothSegmentation:!1,minDetectionConfidence:.5,minTrackingConfidence:.5};return this.pose.setOptions(e),this.pose.onResults(this.onResults.bind(this)),this.isInitialized=!0,!0}catch(e){return!1}}async processFrame(t){var e;if(!this.isInitialized||!this.pose)return null;try{if(Math.random(),0===t.videoWidth||0===t.videoHeight)return void Math.random();this.videoDimensionsLogged||(this.videoDimensionsLogged=!0);const e=1920,s=1080;if(t.videoWidth>e||t.videoHeight>s)return;await this.pose.send({image:t})}catch(s){if(null==(e=s.message)?void 0:e.includes("memory access out of bounds"))return}}onResults(t){var e,s,i,n,a,o,u,r,l;if(this.lastResults=t,!t.poseLandmarks)return this.postureStatus="unknown",this.onPostureChange&&this.onPostureChange("unknown",null),void(this.timerRunning&&(this.accumulatedCorrectMs+=Date.now()-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3))));const h=t.poseLandmarks,c=this.checkBackAlignment(h);null==this._postureGoodCount&&(this._postureGoodCount=0),null==this._postureBadCount&&(this._postureBadCount=0),c?(this._postureGoodCount+=1,this._postureBadCount=0):(this._postureBadCount+=1,this._postureGoodCount=0);const d=(null==(s=null==(e=window.MediaPipeConfig)?void 0:e.SQUAT_CONFIG)?void 0:s.POSTURE_GOOD_FRAMES)??3,_="squats"===this.exerciseMode?(null==(n=null==(i=window.MediaPipeConfig)?void 0:i.SQUAT_CONFIG)?void 0:n.POSTURE_BAD_FRAMES)??6:(null==(o=null==(a=window.MediaPipeConfig)?void 0:a.SQUAT_CONFIG)?void 0:o.POSTURE_BAD_FRAMES)??4;let p=this.postureStatus;this._postureGoodCount>=d?p="correct":this._postureBadCount>=_&&(p="incorrect"),"squats"===this.exerciseMode&&(p="correct"),p!==this.postureStatus&&(this.postureStatus=p,this.onPostureChange&&this.onPostureChange(this.postureStatus,h));const S=(null==(u=window.MediaPipeConfig)?void 0:u.POSE_LANDMARKS)||{},M=h[S.LEFT_HIP||23],m=h[S.RIGHT_HIP||24],T=h[S.LEFT_KNEE||25],y=h[S.RIGHT_KNEE||26],E=M&&m?{x:(M.x+m.x)/2,y:(M.y+m.y)/2}:null,C=T&&y?{x:(T.x+y.x)/2,y:(T.y+y.y)/2}:null;if(E&&C&&(E.y,C.y),"correct"!==this.postureStatus&&!["mountainclimbers","highknees"].includes(this.exerciseMode)&&"squats"!==this.exerciseMode){const t=Date.now(),e=(null==(l=null==(r=window.MediaPipeConfig)?void 0:r.PLANK_CONFIG)?void 0:l.WARNING_COOLDOWN)||2e3;return t-this.lastWarningTime>e&&(this.playWarningSound(),this.lastWarningTime=t,this.onFormFeedback&&this.onFormFeedback({message:"Dangerous posture - straighten your back!",type:"warning",timestamp:t})),void("plank"!==this.exerciseMode&&"sideplank"!==this.exerciseMode||!this.timerRunning||(this.accumulatedCorrectMs+=t-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3))))}if("plank"===this.exerciseMode||"sideplank"===this.exerciseMode){const t=Date.now();if(this.isPlankStrictAndStable(h,t)){this.timerRunning||(this.startCorrectTimestampMs=t,this.timerRunning=!0);const e=this.accumulatedCorrectMs+(t-(this.startCorrectTimestampMs||t)),s=Math.floor(e/1e3);this.onTimeUpdate&&this.onTimeUpdate(s)}else this.timerRunning&&(this.accumulatedCorrectMs+=t-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));return}"squats"===this.exerciseMode?this.updateSquatCounter(h):"lunges"===this.exerciseMode?this.updateLungesCounter(h):"burpees"===this.exerciseMode?this.updateBurpeesCounter(h):"mountainclimbers"===this.exerciseMode?this.updateMountainClimbersCounter(h):"highknees"===this.exerciseMode?this.updateHighKneesCounter(h):"jumpingjacks"===this.exerciseMode?this.updateJumpingJacksCounter(h):"sideplank"===this.exerciseMode?this.updateSidePlankCounter(h):this.updatePushupCounter(h)}calculateAngle(t,e,s){const i=Math.atan2(s.y-e.y,s.x-e.x)-Math.atan2(t.y-e.y,t.x-e.x);let n=Math.abs(180*i/Math.PI);return n>180&&(n=360-n),n}isPlankStrictAndStable(t,e){var s;try{const i=(null==(s=window.MediaPipeConfig)?void 0:s.PLANK_CONFIG)||{},n=i.LEFT_SHOULDER||11,a=i.RIGHT_SHOULDER||12,o=i.LEFT_HIP||23,u=i.RIGHT_HIP||24,r=i.LEFT_ANKLE||27,l=i.RIGHT_ANKLE||28,h=t[n],c=t[a],d=t[o],_=t[u],p=t[r],S=t[l],M=t=>t&&(null==t.visibility||t.visibility>.5),m=M(h)&&M(d),T=M(c)&&M(_);if(!m&&!T)return!1;let y=!1;const E=i.MIN_SIDE_ANGLE??155;if(M(h)&&M(d)&&M(p)){y=this.calculateAngle(h,d,p)>=E}else if(M(c)&&M(_)&&M(S)){y=this.calculateAngle(c,_,S)>=E}else{const t={x:(h.x+c.x)/2,y:(h.y+c.y)/2},e={x:(d.x+_.x)/2,y:(d.y+_.y)/2},s=t.x-e.x,n=t.y-e.y,a=Math.abs(180*Math.atan2(n,s)/Math.PI),o=i.HORIZ_MAX_DEG??30;y=a<=o||a>=180-o}if(!y)return!1;const C=this.perModeState[this.exerciseMode]||this.perModeState.plank,R=(d.y+_.y)/2,g=(h.y+c.y)/2,A=p&&S?(p.y+S.y)/2:null,I=i.MAX_DELTA_PER_SEC??.25,L=e||Date.now(),P=Math.max(1,L-(C._lastTimestamp||L));let N=null==C._lastHipY?0:Math.abs(R-C._lastHipY),H=null==C._lastShoulderY?0:Math.abs(g-C._lastShoulderY),F=null==A||null==C._lastAnkleY?0:Math.abs(A-C._lastAnkleY);const b=N*(1e3/P)>I||H*(1e3/P)>I||null!=A&&F*(1e3/P)>I;C._stableCount=b?0:(C._stableCount||0)+1,C._lastHipY=R,C._lastShoulderY=g,null!=A&&(C._lastAnkleY=A),C._lastTimestamp=L;const w=i.REQUIRED_STABLE_FRAMES??4,x=C._stableCount>=w;if(null!=A){const t=Math.abs(R-A);if(t<(i.MIN_HIP_ANKLE_DY??.06))return!1}return x}catch(i){return!1}}isPushupStartPose(t){var e,s,i;try{const n=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},a=t[n.LEFT_SHOULDER||11],o=t[n.RIGHT_SHOULDER||12],u=t[n.LEFT_HIP||23],r=t[n.RIGHT_HIP||24],l=t[n.LEFT_ANKLE||27],h=t[n.RIGHT_ANKLE||28],c=t=>t&&(null==t.visibility||t.visibility>.5);if(!(c(a)&&c(o)&&c(u)&&c(r)&&c(l)&&c(h)))return!1;const d=(a.y+o.y)/2,_=(u.y+r.y)/2,p=Math.abs(d-_);if(p>((null==(i=null==(s=window.MediaPipeConfig)?void 0:s.PUSHUP_CONFIG)?void 0:i.START_TORSO_DY)??.08))return!1;return!!((l.y+h.y)/2>_)}catch(n){return!1}}isSquatStartPose(t){var e,s,i,n,a,o,u;try{const r=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},l=t[r.LEFT_SHOULDER||11],h=t[r.RIGHT_SHOULDER||12],c=t[r.LEFT_HIP||23],d=t[r.RIGHT_HIP||24],_=t[r.LEFT_KNEE||25],p=t[r.RIGHT_KNEE||26],S=(t[r.LEFT_ANKLE||27],t[r.RIGHT_ANKLE||28],t=>t&&(null==t.visibility||t.visibility>.5));if(!(S(l)&&S(h)&&S(c)&&S(d)&&S(_)&&S(p)))return!1;const M=(c.y+d.y)/2,m=(_.y+p.y)/2;if(m-M<((null==(i=null==(s=window.MediaPipeConfig)?void 0:s.SQUAT_CONFIG)?void 0:i.START_HIP_KNEE_GAP)??.01))return!1;const T={x:(l.x+h.x)/2,y:(l.y+h.y)/2},y={x:(c.x+d.x)/2,y:(c.y+d.y)/2},E=T.x-y.x,C=T.y-y.y,R=Math.abs(180*Math.atan2(E,-C)/Math.PI),g=(null==(a=null==(n=window.MediaPipeConfig)?void 0:n.SQUAT_CONFIG)?void 0:a.STANDING_TORSO_MIN_DEG)??60,A=(null==(u=null==(o=window.MediaPipeConfig)?void 0:o.SQUAT_CONFIG)?void 0:u.STANDING_TORSO_MAX_DEG)??120;return!(R<g||R>A)}catch(r){return!1}}checkBackAlignment(t){var e,s,i,n;try{const a=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},o=t[a.LEFT_SHOULDER||11],u=t[a.RIGHT_SHOULDER||12],r=t[a.LEFT_HIP||23],l=t[a.RIGHT_HIP||24],h=t[a.LEFT_KNEE||25],c=t[a.RIGHT_KNEE||26],d=t[a.LEFT_ANKLE||27],_=t[a.RIGHT_ANKLE||28],p=t=>t&&(null==t.visibility||t.visibility>.5);if("plank"===this.exerciseMode){const t=p(o)&&p(r),e=p(u)&&p(l);if(!t&&!e)return!1}else if("pushups"===this.exerciseMode){if(!(p(o)&&p(u)&&p(r)&&p(l)))return!1}else if(!(p(o)&&p(u)&&p(r)&&p(l)&&p(h)&&p(c)))return!1;const S={x:(o.x+u.x)/2,y:(o.y+u.y)/2},M={x:(r.x+l.x)/2,y:(r.y+l.y)/2},m={x:(h.x+c.x)/2,y:(h.y+c.y)/2},T=p(d)&&p(_)?{x:(d.x+_.x)/2,y:(d.y+_.y)/2}:null,y=T||m,E={x:S.x-M.x,y:S.y-M.y},C=y?{x:y.x-M.x,y:y.y-M.y}:null;let R=!1;if("plank"===this.exerciseMode){const t=(null==(s=window.MediaPipeConfig)?void 0:s.PLANK_CONFIG)||{},e=p(o)&&p(r)&&p(d),i=p(u)&&p(l)&&p(_);if(e||i){const s=e?o:u,i=e?r:l,n=e?d:_,a=this.calculateAngle(s,i,n);if(R=a>=(t.MIN_SIDE_ANGLE??155),R&&T){const e=this.calculateAngle(r,h,d),s=this.calculateAngle(l,c,_),i=t.KNEE_MIN_DEG??150;R=R&&(e>=i&&s>=i)}}else{let e=-1;if(C){const t=Math.hypot(E.x,E.y)||1,s=Math.hypot(C.x,C.y)||1;e=(E.x*C.x+E.y*C.y)/(t*s)}const s=Math.abs(Math.max(-1,Math.min(1,e))),i=!!C&&s>=(t.STRAIGHT_ABS_COS_MIN??.9),n=S.x-M.x,a=S.y-M.y,o=Math.abs(180*Math.atan2(a,n)/Math.PI),u=t.HORIZ_MAX_DEG??35,p=o<=u||o>=180-u;let m=!0;if(T){const e=this.calculateAngle(r,h,d),s=this.calculateAngle(l,c,_),i=t.KNEE_MIN_DEG??150;m=e>=i&&s>=i}R=i&&p&&m}}else if("squats"===this.exerciseMode){const t=(null==(i=window.MediaPipeConfig)?void 0:i.SQUAT_CONFIG)||{},e=this.calculateAngle(o,r,h),s=(e+this.calculateAngle(u,l,c))/2,n=t.HIP_ANGLE_MIN??120,a=t.HIP_ANGLE_COLLAPSE??60,d=S.x-M.x,_=S.y-M.y,p=Math.abs(180*Math.atan2(d,-_)/Math.PI),T=t.TORSO_TILT_MAX??60,y=m&&M.y>m.y,E=t.COLLAPSE_TILT_MIN??70;R=!(s<a&&p>E)&&(!!y||s>=n&&p<=T)}else{const t=(null==(n=window.MediaPipeConfig)?void 0:n.PUSHUP_CONFIG)||{},e=t.SIDE_ABS_COS_MIN??.82,s=t.HORIZ_TORSO_MAX_DEG??35;if(T&&C){let t=-1;const s=Math.hypot(E.x,E.y)||1,i=Math.hypot(C.x,C.y)||1;t=(E.x*C.x+E.y*C.y)/(s*i);R=Math.abs(Math.max(-1,Math.min(1,t)))>=e}else{const t=S.x-M.x,e=S.y-M.y,i=Math.abs(180*Math.atan2(e,t)/Math.PI);R=(i<=s||i>=180-s)&&!(i>=70&&i<=110)}}return R}catch(a){return!1}}updatePushupCounter(t){var e,s,i,n,a,o;try{const u=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},r=(null==(s=window.MediaPipeConfig)?void 0:s.PUSHUP_CONFIG)||{},l=t[u.LEFT_SHOULDER||11],h=t[u.LEFT_ELBOW||13],c=t[u.LEFT_WRIST||15],d=t[u.RIGHT_SHOULDER||12],_=t[u.RIGHT_ELBOW||14],p=t[u.RIGHT_WRIST||16],S=t[u.LEFT_HIP||23],M=t[u.RIGHT_HIP||24];if(!(l&&h&&c&&d&&_&&p&&S&&M))return;const m=this.calculateAngle(l,h,c),T=(m+this.calculateAngle(d,_,p))/2,y=(l.y+d.y)/2,E=r.ELBOW_ANGLE_DOWN||95,C=r.ELBOW_ANGLE_UP||155,R=r.SHOULDER_HEIGHT_DOWN||.02,g=Math.abs((l.y+d.y)/2-(S.y+M.y)/2),A=(r.TORSO_VERTICAL_DY,!(g<(r.STANDING_DY_MIN??.05))&&(l.y+d.y)/2<(S.y+M.y)/2-(r.STANDING_DY_MIN??.02)),I=this.perModeState.pushups;I._baselineShoulderY||(I._baselineShoulderY=y),Math.abs((l.y+d.y)/2-(S.y+M.y)/2)<.12&&(I._baselineShoulderY=.95*I._baselineShoulderY+.05*y);const L=y-(I._baselineShoulderY||y),P=r.SHOULDER_DROP_THRESHOLD??.06,N=T<=E||L>=P||y>=1-R,H=T>=C&&A;I._inPositionCount||(I._inPositionCount=0);this.isPushupStartPose(t)?I._inPositionCount+=1:I._inPositionCount=0;const F=(null==(n=null==(i=window.MediaPipeConfig)?void 0:i.PUSHUP_CONFIG)?void 0:n.START_STABLE_FRAMES)??6;I._isInStartPose=I._inPositionCount>=F;const b=(null==(o=null==(a=window.MediaPipeConfig)?void 0:a.PUSHUP_CONFIG)?void 0:o.MIN_REP_MS)??400;I._lastRepAt||(I._lastRepAt=0);const w=Date.now();if("correct"!==this.postureStatus||!I._isInStartPose)return;"up"===I.state?N&&w-I._lastRepAt>b&&(I.state="down",I.count+=1,I._lastRepAt=w,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(I.count),this.onFormFeedback&&this.onFormFeedback({message:`Push-up ${I.count}`,type:"success",timestamp:w})):"down"===I.state&&(H||!N&&T>=C)&&(I.state="up")}catch(u){}}updateSquatCounter(t){var e,s,i,n;try{const a=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},o=(null==(s=window.MediaPipeConfig)||s.SQUAT_CONFIG,t[a.LEFT_HIP||23]),u=t[a.RIGHT_HIP||24],r=t[a.LEFT_KNEE||25],l=t[a.RIGHT_KNEE||26],h=t[a.LEFT_ANKLE||27],c=t[a.RIGHT_ANKLE||28],d=t[a.LEFT_SHOULDER||11],_=t[a.RIGHT_SHOULDER||12];if(!(o&&u&&r&&l&&h&&c&&d&&_))return;const p=(d.y+_.y)/2,S=(o.y+u.y)/2,M=t[a.NOSE||0],m=Math.abs(p-S),T=.08,y=Math.abs(((null==M?void 0:M.y)??0)-S);let E=!1;m<=T&&y<=.1&&(E=!0,this.onFormFeedback&&this.onFormFeedback({message:"وضع الجسم أفقي، لن يتم العد إلا في وضع الاسكوات الصحيح",type:"warning",timestamp:Date.now()}));const C=t[a.LEFT_WRIST||15],R=t[a.RIGHT_WRIST||16],g=t[a.LEFT_ANKLE||27],A=t[a.RIGHT_ANKLE||28],I=.07;let L=!1;if(C&&R&&g&&A){const t=(C.y+R.y)/2;t>=(g.y+A.y)/2-I&&(L=!0,this.onFormFeedback&&this.onFormFeedback({message:"اليدين على الأرض، لن يتم العد إلا في وضع الاسكوات الصحيح",type:"warning",timestamp:Date.now()}))}const P={x:(o.x+u.x)/2,y:(o.y+u.y)/2},N={x:(r.x+l.x)/2,y:(r.y+l.y)/2},H=(h.x,c.x,h.y,c.y,d.x,_.x,d.y,_.y,this.calculateAngle(o,r,h)),F=(this.calculateAngle(u,l,c),r.y),b=l.y,w=Math.abs(F-b),x=w<=.05,O=P.y,G=N.y,f=O>G,D=O<G,v=this.perModeState.squats,K=(null==(n=null==(i=window.MediaPipeConfig)?void 0:i.SQUAT_CONFIG)?void 0:n.MIN_REP_MS)??500;v._lastRepAt||(v._lastRepAt=0);const k=Date.now();"up"===v.state?f&&x&&!E&&!L&&k-v._lastRepAt>K?(v.state="down",v.count+=1,v._lastRepAt=k,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(v.count)):f&&x&&(E||L||v._lastRepAt):"down"===v.state&&D&&(v.state="up")}catch(a){}}updateLungesCounter(t){var e,s;try{const i=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},n=(null==(s=window.MediaPipeConfig)||s.LUNGES_CONFIG,t[i.LEFT_HIP||23]),a=t[i.RIGHT_HIP||24],o=t[i.LEFT_KNEE||25],u=t[i.RIGHT_KNEE||26],r=t[i.LEFT_ANKLE||27],l=t[i.RIGHT_ANKLE||28];if(!(n&&a&&o&&u&&r&&l))return;const h=t[i.LEFT_WRIST||15],c=t[i.RIGHT_WRIST||16],d=t[i.LEFT_ANKLE||27],_=t[i.RIGHT_ANKLE||28],p=.07;let S=!1;if(h&&c&&d&&_){const t=(h.y+c.y)/2;t>=(d.y+_.y)/2-p&&(S=!0)}const M={x:(n.x+a.x)/2,y:(n.y+a.y)/2},m=this.calculateAngle(n,o,r),T=this.calculateAngle(a,u,l),y=m<T,E=y?o:u,C=y?m:T,R=y?T:m,g=T<m,A=g?T:m,I=g?m:T,L=(M.y,E.y,.06),P=120,N=100,H=.08,F=Math.abs(o.y-u.y)>L,b=R<P,w=C<N,x=y?n:a,O=y?r:l,G=Math.abs(x.x-O.x)<H,f=F&&b&&w&&G,D=I<P,v=A<N,K=g?a:n,k=g?l:r,U=Math.abs(K.x-k.x)<H,W=f||F&&D&&v&&U,Y=C>=160&&R>=150,B=this.perModeState.lunges;"up"===B.state?!S&&W&&(B.state="down",B.count+=1,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(B.count),this.onFormFeedback&&this.onFormFeedback({message:`Lunge ${B.count}`,type:"success",timestamp:Date.now()})):"down"===B.state&&Y&&(B.state="up")}catch(i){}}updateMountainClimbersCounter(t){var e;try{const s=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},i=t[s.LEFT_HIP||23],n=t[s.RIGHT_HIP||24],a=t[s.LEFT_KNEE||25],o=t[s.RIGHT_KNEE||26],u=t[s.LEFT_ANKLE||27],r=t[s.RIGHT_ANKLE||28];if(!(i&&n&&a&&o&&u&&r))return;Math.abs(a.y-i.y),Math.abs(o.y-n.y);this._lastLeftKneeY||(this._lastLeftKneeY=a.y),this._lastRightKneeY||(this._lastRightKneeY=o.y),this._climberState||(this._climberState="neutral"),this._lastClimberTime||(this._lastClimberTime=Date.now());const l=.05,h=250,c=Date.now(),d=a.y-this._lastLeftKneeY,_=o.y-this._lastRightKneeY,p=d>l&&_<-l||d<-l&&_>l,S=this.perModeState.mountainclimbers;if("neutral"===S._climberState){if(p&&c-S._lastClimberTime>h&&(S._climberState="moving",S._lastClimberTime=c,S.count+=1,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(S.count),this.onFormFeedback)){const t=d>_?"Left":"Right";this.onFormFeedback({message:`${t} knee drive - Rep ${S.count}`,type:"success",timestamp:c})}}else"moving"===S._climberState&&(p||(S._climberState="neutral"));S._lastLeftKneeY=a.y,S._lastRightKneeY=o.y,Math.abs(i.y-n.y)>.1&&this.onFormFeedback&&Math.random()<.1&&this.onFormFeedback({message:"Keep hips level!",type:"warning",timestamp:c})}catch(s){}}updateBurpeesCounter(t){var e;try{const s=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},i=t[s.NOSE||0],n=t[s.LEFT_WRIST||15],a=t[s.RIGHT_WRIST||16],o=t[s.LEFT_INDEX||19],u=t[s.RIGHT_INDEX||20];if(!i||!n||!a)return;const r=i.y,l=o?o.y:n.y,h=u?u.y:a.y,c=l<r&&h<r;this._burpeeState||(this._burpeeState="ready"),this.perModeState.burpees._burpeeState||(this.perModeState.burpees._burpeeState="ready");const d=this.perModeState.burpees;"ready"===d._burpeeState?c&&(d._burpeeState="jumping",d.count+=1,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(d.count),this.onFormFeedback&&this.onFormFeedback({message:`Burpee ${d.count} - Hands above head!`,type:"success",timestamp:Date.now()})):"jumping"===d._burpeeState&&(c||(d._burpeeState="ready"))}catch(s){}}updateHighKneesCounter(t){var e;try{const s=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},i=t[s.LEFT_HIP||23],n=t[s.RIGHT_HIP||24],a=t[s.LEFT_KNEE||25],o=t[s.RIGHT_KNEE||26],u=t[s.LEFT_ANKLE||27],r=t[s.RIGHT_ANKLE||28];if(!(i&&n&&a&&o&&u&&r))return;const l=.03,h=i.y-a.y>l,c=n.y-o.y>l,d=h||c,_=this.perModeState.highknees;_._highKneesState||(_._highKneesState="stopped"),_._startTime||(_._startTime=0),_._lastUpdateTime||(_._lastUpdateTime=0);const p=Date.now();if("stopped"===_._highKneesState)d&&(_._highKneesState="active",_._startTime=p,_._lastUpdateTime=p,_.count=0);else if("active"===_._highKneesState)if(d){_._lastUpdateTime=p;const t=Math.floor((p-_._startTime)/1e3);t>_.count&&(_.count=t,this.onPushupCount&&this.onPushupCount(_.count))}else{p-_._lastUpdateTime>1500&&(_._highKneesState="stopped")}}catch(s){}}updateJumpingJacksCounter(t){var e,s;try{const i=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},n=(null==(s=window.MediaPipeConfig)?void 0:s.JUMPINGJACKS_CONFIG)||{},a=t[i.LEFT_SHOULDER||11],o=t[i.RIGHT_SHOULDER||12],u=t[i.LEFT_HIP||23],r=t[i.RIGHT_HIP||24],l=t[i.LEFT_KNEE||25],h=t[i.RIGHT_KNEE||26],c=t[i.LEFT_ELBOW||13],d=t[i.RIGHT_ELBOW||14],_=t[i.LEFT_WRIST||15],p=t[i.RIGHT_WRIST||16],S=t[i.LEFT_ANKLE||27],M=t[i.RIGHT_ANKLE||28];if(!(a&&o&&u&&r&&l&&h&&c&&d&&_&&p&&S&&M))return;const m=this.calculateAngle(c,a,_),T=this.calculateAngle(d,o,p),y=this.calculateAngle(l,u,S),E=this.calculateAngle(h,r,M),C=(this.calculateAngle(u,l,S),this.calculateAngle(r,h,M),n.SHOULDER_ABDUCTION_DOWN||60),R=n.SHOULDER_ABDUCTION_UP||120,g=n.HIP_ABDUCTION_DOWN||25,A=n.HIP_ABDUCTION_UP||30,I=(m+T)/2,L=(y+E)/2,P=(_.y+p.y)/2,N=(a.y+o.y)/2,H=(S.y,M.y,u.y,r.y,P<N),F=Math.abs(S.x-M.x)>1.2*Math.abs(u.x-r.x),b=H&&F||I>R&&L>A,w=!H&&!F||I<C&&L<g,x=this.perModeState.jumpingjacks,O=n.MIN_REP_MS||800;x._lastRepAt||(x._lastRepAt=0);const G=Date.now();"down"===x.state?b&&G-(x._lastStateChange||0)>300&&(x.state="up",x._lastStateChange=G):"up"===x.state&&w&&G-x._lastRepAt>O&&G-(x._lastStateChange||0)>300&&(x.state="down",x.count+=1,x._lastRepAt=G,x._lastStateChange=G,this.playSuccessSound(),this.onPushupCount&&this.onPushupCount(x.count),this.onFormFeedback&&this.onFormFeedback({message:`Jumping Jack ${x.count}`,type:"success",timestamp:G}))}catch(i){}}updateSidePlankCounter(t){var e,s;try{const i=(null==(e=window.MediaPipeConfig)?void 0:e.POSE_LANDMARKS)||{},n=(null==(s=window.MediaPipeConfig)?void 0:s.SIDEPLANK_CONFIG)||{},a=t[i.LEFT_SHOULDER||11],o=t[i.RIGHT_SHOULDER||12],u=t[i.LEFT_ELBOW||13],r=t[i.RIGHT_ELBOW||14],l=t[i.LEFT_WRIST||15],h=t[i.RIGHT_WRIST||16],c=t[i.LEFT_HIP||23],d=t[i.RIGHT_HIP||24],_=t[i.LEFT_KNEE||25],p=t[i.RIGHT_KNEE||26],S=t[i.LEFT_ANKLE||27],M=t[i.RIGHT_ANKLE||28],m=(t[i.NOSE||0],t[i.LEFT_EAR||7]),T=t[i.RIGHT_EAR||8],y=t=>t&&(null==t.visibility||t.visibility>.5),E=y(a)&&y(u)&&y(c)&&y(_)&&y(S),C=y(o)&&y(r)&&y(d)&&y(p)&&y(M);if(!E&&!C)return;const R=E&&(!C||E),g=R?a:o,A=R?u:r,I=R?l:h,L=R?c:d,P=R?S:M,N=R?m:T,H=this.calculateAngle(g,A,I),F=n.SHOULDER_ANGLE_MIN||80,b=n.SHOULDER_ANGLE_MAX||100,w=H>=F&&H<=b,x=this.calculateAngle(g,L,P),O=n.TORSO_ANGLE_MIN||160,G=n.TORSO_ANGLE_MAX||200,f=x>=O&&x<=G,D=(g.y+P.y)/2,v=n.HIP_SAG_THRESHOLD||.05,K=L.y>D+v,k=n.HIP_HIKE_THRESHOLD||.05,U=L.y<D-k,W=n.ELBOW_ALIGNMENT_THRESHOLD||.08,Y=Math.abs(A.x-g.x)<W,B=n.FEET_STACKING_THRESHOLD||.1,j=Math.abs(S.x-M.x)<B;let q=!0;if(N&&y(N)){const t=this.calculateAngle(N,g,L),e=n.HEAD_NECK_ANGLE_MIN||160,s=n.HEAD_NECK_ANGLE_MAX||200;q=t>=e&&t<=s}const X=w&&f&&!K&&!U&&Y&&j&&q;X?(this._postureGoodCount=(this._postureGoodCount||0)+1,this._postureBadCount=0):(this._postureBadCount=(this._postureBadCount||0)+1,this._postureGoodCount=0);const Q=n.POSTURE_GOOD_FRAMES||3,J=n.POSTURE_BAD_FRAMES||4;let $=this.postureStatus;if(this._postureGoodCount>=Q?$="correct":this._postureBadCount>=J&&($="incorrect"),$!==this.postureStatus&&(this.postureStatus=$,this.onPostureChange&&this.onPostureChange(this.postureStatus,t)),"correct"===this.postureStatus){const t=Date.now();this.timerRunning||(this.startCorrectTimestampMs=t,this.timerRunning=!0);const e=this.accumulatedCorrectMs+(t-(this.startCorrectTimestampMs||t)),s=Math.floor(e/1e3);this.onTimeUpdate&&this.onTimeUpdate(s)}else this.timerRunning&&(this.accumulatedCorrectMs+=Date.now()-this.startCorrectTimestampMs,this.timerRunning=!1,this.startCorrectTimestampMs=0,this.onTimeUpdate&&this.onTimeUpdate(Math.floor(this.accumulatedCorrectMs/1e3)));if(!X&&this.onFormFeedback){const t=Date.now(),e=n.WARNING_COOLDOWN||2e3;if(t-this.lastWarningTime>e){let e="";K?e="Hip sagging - lift your hips up!":U?e="Hip too high - lower your hips!":Y?j?w?f||(e="Keep your body straight!"):e="Adjust your arm position!":e="Stack your feet together!":e="Keep elbow under shoulder!",e&&(this.onFormFeedback({message:e,type:"warning",timestamp:t}),this.lastWarningTime=t)}}}catch(i){}}playWarningSound(){try{const t=new(window.AudioContext||window.webkitAudioContext),e=t.createOscillator(),s=t.createGain();e.connect(s),s.connect(t.destination),e.frequency.setValueAtTime(800,t.currentTime),e.type="sine",s.gain.setValueAtTime(0,t.currentTime),s.gain.linearRampToValueAtTime(.3,t.currentTime+.1),s.gain.exponentialRampToValueAtTime(.01,t.currentTime+.5),e.start(t.currentTime),e.stop(t.currentTime+.5)}catch(t){}}playSuccessSound(){try{const t=new Audio("/assets/sounds/pop.wav");t.volume=.5,t.play().catch(t=>{})}catch(t){}}drawPoseOverlay(t,e,s,i){if(Math.random(),!e.poseLandmarks||!t)return;t.save(),t.clearRect(0,0,s,i);const n=e.poseLandmarks;n.forEach((e,n)=>{if(e.visibility&&e.visibility>.5){const n=e.x*s,a=e.y*i;t.beginPath(),t.arc(n,a,6,0,2*Math.PI),t.fillStyle=e.visibility>.7?"#10B981":"#F59E0B",t.fill(),t.strokeStyle="#FFFFFF",t.lineWidth=2,t.stroke()}}),Math.random(),this.drawBasicConnections(t,n,s,i),t.restore()}drawBasicConnections(t,e,s,i){[[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]].forEach(([n,a])=>{const o=e[n],u=e[a];o&&u&&o.visibility>.5&&u.visibility>.5&&(t.beginPath(),t.moveTo(o.x*s,o.y*i),t.lineTo(u.x*s,u.y*i),t.strokeStyle="#3B82F6",t.lineWidth=3,t.stroke())}),Math.random()}resetCounter(){const t=this.exerciseMode;this.perModeState&&this.perModeState[t]&&(this.perModeState[t].count=0,this.perModeState[t].state="up","mountainclimbers"===t&&(this.perModeState[t]._lastLeftKneeY=null,this.perModeState[t]._lastRightKneeY=null,this.perModeState[t]._climberState="neutral",this.perModeState[t]._lastClimberTime=0),"burpees"===t&&(this.perModeState[t]._burpeeState="ready"),"jumpingjacks"===t&&(this.perModeState[t]._lastRepAt=0),"sideplank"===t&&(this.perModeState[t].state="neutral",this.perModeState[t].count=0),"plank"===t&&(this.perModeState[t]._stableCount=0,this.perModeState[t]._lastHipY=null,this.perModeState[t]._lastShoulderY=null,this.perModeState[t]._lastAnkleY=null,this.perModeState[t]._lastTimestamp=0)),this.postureStatus="unknown",this.accumulatedCorrectMs=0,this.timerRunning=!1,this.startCorrectTimestampMs=0}getStats(){const t=this.exerciseMode,e=this.perModeState&&this.perModeState[t]?this.perModeState[t]:{count:0,state:"up"};return{count:e.count||0,state:e.state||"up",posture:this.postureStatus,timeSec:Math.floor((this.accumulatedCorrectMs+(this.timerRunning?Date.now()-this.startCorrectTimestampMs:0))/1e3)}}getLastResults(){return this.lastResults}setCallbacks({onPushupCount:t,onPostureChange:e,onFormFeedback:s,onTimeUpdate:i}){this.onPushupCount=t,this.onPostureChange=e,this.onFormFeedback=s,this.onTimeUpdate=i}cleanup(){this.pose&&(this.pose.close(),this.pose=null),this.isInitialized=!1}}export{t as default};
//# sourceMappingURL=poseDetection-BJEmLmEJ.js.map
